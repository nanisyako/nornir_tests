

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>nornir_tests &mdash; nornir_tests 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="#" class="icon icon-home"> nornir_tests
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">nornir_tests</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>nornir_tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<a class="reference external image-reference" href="https://patrickdaj.github.io/nornir_tests"><img alt="Documentation" src="https://img.shields.io/badge/docs-passing-green.svg" /></a>
<a class="reference external image-reference" href="https://github.com/patrickdaj/nornir_tests/actions?query=workflow%3Atest_nornir_tests"><img alt="test_nornir_tests" src="https://github.com/patrickdaj/nornir_tests/workflows/test_nornir_tests/badge.svg" /></a>
<div class="section" id="nornir-tests">
<h1>nornir_tests<a class="headerlink" href="#nornir-tests" title="Permalink to this headline">¶</a></h1>
<p>Collection of test/assertion plugins for <a class="reference external" href="github.com/nornir-automation/nornir/">nornir</a></p>
<p>The point of nornir_tests is to provide a bit more flexibility in how the data that is sent back from
a task run is validated.  When using a task like napalm_get or netmiko_send_command, the results
come back in a variety of forms and typically code needs to be written to validate and/or act upon it.
One issue with this methodology is that you can’t easily impact the result passed/failed attribute.
nornir_tests is meant to validate the result data and make sure the returned result is correct and not
just that it came back.  It also adds some utility methods that pair well with the tests.  It utilizes
a few different libraries to hopefully make things a bit easier to test.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">nornir_tests</span>
</pre></div>
</div>
</div>
<div class="section" id="plugins">
<h2>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tests">
<h3>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>regexp</strong> - Run assertions on nornir results using assertpy’s assertions</p></li>
<li><p><strong>jpath</strong> - Run assertions on nornir results dictionaries using many of assertpy’s assertions</p></li>
<li><p><strong>timing</strong> - Gather timing info from tasks</p></li>
<li><p><strong>wait</strong> - Re-run tasks until assertions pass</p></li>
<li><p><strong>xpath</strong> - Run assertions on nornir results XML using many of assertpy’s assertions</p></li>
<li><p><strong>callback</strong> - Run a custom callback to handle results</p></li>
<li><p><strong>shorten</strong> - (Not implemented) Shorten the data in result using jpath/xpath/regexp</p></li>
<li><p><strong>when</strong> - (Not implemented) Conditionally skip tasks based on jpath/xpath/regexp</p></li>
<li><p><strong>loop</strong> - (Work in progress) Repeat task using a list of values</p></li>
</ul>
</div>
<div class="section" id="tasks">
<h3>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>wrap_task</strong> - Wrap a nornir task with tests without having to use &#64; decorator syntax</p></li>
</ul>
</div>
</div>
<div class="section" id="common-uses">
<h2>Common Uses<a class="headerlink" href="#common-uses" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Validating returned results and modifying Result object based on test parameters</p></li>
<li><p>Only running a task on a subset of inventory depending on a pre-test</p></li>
<li><p>Timing a task and making sure it completes within a certain amount of time</p></li>
<li><p>Asserting particular values exist at a path using regexp, jsonpath or xpath</p></li>
<li><p>Passing a task for an expected exception</p></li>
<li><p>Testing a condition repeatedly until all tests are passing, like a reboot, or job completing</p></li>
<li><p>Nest multiple tests</p></li>
<li><p>Reduce the result in some fashion</p></li>
</ul>
<p>One thing to address is that all of these things can be done with Nornir and Python without
this module except.  In most cases the hope is that the code involved will look cleaner and
be much shorter with nornir_tests.  There are certainly some neat things that nornir_tests can
do that would require some trickier/uglier code to accomplish without it.  The real goal is to
obtain a clean way to test nornir results but there are a few random methods that have been
implemented that are more of nice to haves such as shorten and loop.</p>
</div>
<div class="section" id="what-does-it-do-exactly">
<h2>What does it do exactly?<a class="headerlink" href="#what-does-it-do-exactly" title="Permalink to this headline">¶</a></h2>
<p>Integrate validations into running of a task.  This allows the validation to impact whether or
not the task failed.  Validations can be chained together.  Supports jsonpath, xpath, and regexp
validations.  The default assertion performed is ‘is_equal_to’ from the assertpy library but
most will work within reason.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jpath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;$..state&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="n">fail_task</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@jpath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;$..peer.connection&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="n">fail_task</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_ha_info</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">netmiko_send_command</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">command_string</span><span class="o">=</span><span class="s1">&#39;show ha info&#39;</span><span class="p">,</span> <span class="n">use_textfsm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">nr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_ha_info</span><span class="p">)</span>
</pre></div>
</div>
<p>Retry a task until a condition is met.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@xpath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;.//neighbor/entry[@name=&quot;router1&quot;].connected&#39;</span><span class="p">,</span> <span class="n">assertion</span><span class="o">=</span><span class="s1">&#39;is_true&#39;</span><span class="p">)</span>
<span class="nd">@wait</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_ospf_neighbors</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">netmiko_send_command</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">command_string</span><span class="o">=</span><span class="s1">&#39;show ip ospf nei&#39;</span><span class="p">,</span> <span class="n">use_textfsm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">nr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_ospf_neighbors</span><span class="p">)</span>
</pre></div>
</div>
<p>Conditionally run a task on a particular nornir inventory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@when</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">failed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@when</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;$.version&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;10.0&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_when_failed_and_version_10</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">netmiko_send_command</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">command_string</span><span class="o">=</span><span class="s1">&#39;echo failures&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">netmiko_send_command</span><span class="p">,</span> <span class="n">command_string</span><span class="o">=</span><span class="s1">&#39;show system info&#39;</span><span class="p">,</span> <span class="n">use_textfsm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">nr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_when_failed_and_version_10</span><span class="p">)</span>
</pre></div>
</div>
<p>Time tasks and optionally fail them if criteria are not met.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@timing</span><span class="p">(</span><span class="n">max_run_time</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fail_task</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">netmiko_send_command</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">command_string</span><span class="o">=</span><span class="s1">&#39;check status&#39;</span><span class="p">)</span>

<span class="n">nr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">check_status</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="alternative-to-decorator-syntax">
<h2>Alternative to &#64; decorator syntax<a class="headerlink" href="#alternative-to-decorator-syntax" title="Permalink to this headline">¶</a></h2>
<p>All the previous examples used &#64; decorator syntax but that is not the most flexible way of
using nornir_tests.  There are requirements that go along with using decorator syntax in that
the function must return a result and therefore the way it is called in the function may not
be ideal.</p>
<p>The alternative and probably easier method is to wrap the task directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vyos</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">wrap_task</span><span class="p">(</span><span class="n">napalm_get</span><span class="p">),</span> <span class="n">getters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interfaces&#39;</span><span class="p">],</span>
    <span class="n">tests</span><span class="o">=</span><span class="p">[</span>
        <span class="n">jpath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;interfaces.eth0.is_up&#39;</span><span class="p">,</span> <span class="n">assertion</span><span class="o">=</span><span class="s1">&#39;is_true&#39;</span><span class="p">,</span> <span class="n">fail_task</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">until</span><span class="p">(</span><span class="n">initial_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">reset_conns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="viewing-test-results">
<h2>Viewing test results<a class="headerlink" href="#viewing-test-results" title="Permalink to this headline">¶</a></h2>
<p>The test results can be seen using the standard print_result in nornir_utils but an extended
version of print_result is also included in this module to better print test records.</p>
<p>For more details, see the <a class="reference external" href="https://patrickdaj.github.io/nornir_tests/html/index.html">documentation</a></p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p>The nornir_tests plugin uses other libraries that are pretty critical to know in order to use nornir_tests efficiently.</p>
<p><a class="reference external" href="https://github.com/h2non/jsonpath-ng">jsonpath_ng</a> - The github page has a fairly good intro to using jsonpath.</p>
<p><a class="reference external" href="https://devhints.io/xpath">xpath cheatsheat</a> - The lxml documentation is great and all but its quite a bit and using something like this cheat sheet is a bit less daunting.</p>
<p><a class="reference external" href="https://github.com/assertpy/assertpy">assertpy</a> - This documentation is pretty concise and this module is really the reason I wrote nornir_tests.  Prior to nornir_tests, I was running tasks that executed a bunch of python asserts using tasks.  It didn’t permit stacking of assertions or very flexible control of whether or not it should fail a task.</p>
<div class="toctree-wrapper compound">
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/tests.html">tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/tasks.html">tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/functions.html">functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorials/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorials/all-methods-of-using.html">All methods of using tests</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api/index.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Patrick Avery

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>